CREATE OR REPLACE VIEW NETSUITE_OPPORTUNITIES 
(
	DOCUMENT_NUMBER				COMMENT 'OPPORTUNITY DOCUMENT NUMBER'
	,SALES_REP_NAME				COMMENT 'OPPORTUNITY ASSIGNED SALES REP - NOT CUSTOMER ASSIGNED SALES REP'
	,MANAGER_NAME				COMMENT 'SALES REP ASSIGNED MANAGER - FROM THE EMPLOYEES TABLE IN NETSUITE'
	,TITLE						COMMENT 'OPPORTUNITY TITLE'
	,CUSTOMER_NAME				COMMENT 'CUSTOMER NAME'
	,CUSTOMER_ID				COMMENT 'NETSUITE CUSTOMER DISPLAY ID'
	,CONTRACT_OPS_OPPORTUNITY	COMMENT 'BOOLEAN FIELD IF AN OPPORTUNTIY IS TAGGED BY CONTRACT OPERATIONS AS A CONTRACT OPPORTUNITY'
	,CUSTOMER_STATE				COMMENT 'CUSTOMER STATE'
	,OPPORTUNITY_STATUS			COMMENT 'OPPORTUNITY PIPELINE STATUS'
	,FORECAST_TYPE				COMMENT 'FORECAST TYPE'
	,OPPORTUNITY_CLASS			COMMENT 'OPPORTUNITY ASSIGNED CLASS - TYPICALLY THE MAIN PRODUCT RELEVANT TO THE OPPORTUNITY'
	,BUYING_REASON				COMMENT 'BUYING REASON FOR THE OPPORTUNITY'
	,PROJECTED_TOTAL			COMMENT 'OPPORTUNITY PROJECTED (ESTIMATED) TOTAL'
	,WEIGHTED_TOTAL				COMMENT 'OPPORTUNITY WEIGHTED (CONFIDENCE WEIGHT) TOTAL'
	,EXPECTED_CLOSE_DATE		COMMENT 'OPPORTUNITY EXPECTED (ESTIMATED) CLOSE DATE'
	,ACTUAL_CLOSE_DATE			COMMENT 'OPPORTUNITY ACTIAL CLOSE DATE (IF APPLIES)'
	,ACCOUNTING_PERIOD_NAME		COMMENT 'ACCOUNTING PERIOD NAME FOR THE OPPORTUNITY'
	,OPPORTUNITY_TYPE			COMMENT 'DENOTES WHETHER AN OPPORTUNITY IS A HISTORICAL CLOSED DEAL (STATUS DENOTES CLOSED, AND FORECAST TYPE IS NOT OMITTED), A PIPELINE DEAL (STATUS DOES NOT DENOTE CLOSED, AND FORECAST TYPE IS NOT OMITTED), OR OMITTED (FORECAST TYPE IS OMITTED)'
)
COMMENT = 'LAITH BARAKAT | THIS VIEW CONTAINS ALL OPPORTUNITIES WITHIN NETSUITE AND RELEVANT INFORMATION ON CURRENT STATUS.'

AS 
SELECT
	opp.TRANID				           AS DOCUMENT_NUMBER 			--document number
	,reps.FULL_NAME			           AS SALES_REP_NAME			--sales reps
    ,mgr.FULL_NAME                     AS MANAGER_NAME             --manager
	,opp.TITLE				           AS TITLE 					--title
	,cus.CUSTOMER_NAME 		           AS CUSTOMER_NAME			--customer name
	,cus.CUSTOMER_ID		           AS CUSTOMER_ID				--customer ID
	,opp.IS_CONTRACT		           AS CONTRACT_OPS_OPPORTUNITY	--contract ops
	,cus.STATE			               AS CUSTOMER_STATE			--billing state
	,sts.NAME 				           AS OPPORTUNITY_STATUS 		--opportunity status
	,opp.FORECAST_TYPE		           AS FORECAST_TYPE			--forecast type 
	,cls.FULL_NAME			           AS OPPORTUNITY_CLASS		--product class
	,opp.BUYING_REASON_SNOWFLAKE       AS BUYING_REASON
	,opp.PROJECTED_TOTAL 	           AS PROJECTED_TOTAL			--projected total
	,opp.WEIGHTED_TOTAL 	           AS WEIGHTED_TOTAL			--weighted total
	,opp.EXPECTED_CLOSE		           AS EXPECTED_CLOSE_DATE		--expected close
	,opp.CLOSED				           AS ACTUAL_CLOSE_DATE		--actual close
	,ap.NAME 				           AS ACCOUNTING_PERIOD_NAME
	,CASE
			WHEN
				UPPER(sts.NAME) IN ('ADOPTION/IDENTIFIED', 'FINALIST/NEGOTIATING', 'ORDER RECEIVED', 'PRE-WORK', 'PRESENTED/PROPOSED', 'RIVERSIDE SELECTED')
				AND
				UPPER(opp.FORECAST_TYPE) != 'OMITTED'
			THEN
				'Pipeline'
			WHEN
				UPPER(sts.NAME) IN ('CLOSED(CANCELLED)', 'CLOSED(LOST)', 'CLOSED(WON)')
				AND
				UPPER(opp.FORECAST_TYPE) != 'OMITTED'
			THEN
				'Closed Deal'
			ELSE
				'Omitted'
		END					AS OPPORTUNITY_TYPE
	
FROM "VW_OPPORTUNITIES" opp
LEFT JOIN "VW_SALES_REPS" reps ON opp.SALES_REP_ID                = reps.SALES_REP_ID
LEFT JOIN "VW_EMPLOYEES" mgr ON reps.SUPERVISOR_ID             = mgr.EMPLOYEE_ID
LEFT JOIN "VW_COMPANY_STATUS" sts ON opp.COMPANY_STATUS_ID = sts.COMPANY_STATUS_ID
LEFT JOIN "VW_CLASSES" cls ON opp.PRODUCT_CLASS_ID = cls.CLASS_ID
LEFT JOIN "VW_TRANSACTIONS" txn ON opp.TRANSACTION_ID = txn.TRANSACTION_ID
LEFT JOIN "DEV_RIVERSIDE_MASTER_DATA"."CUSTOMER"."VW_ALL_SOURCE_CUSTOMER" cus ON txn.ENTITY_ID = cus.CUSTOMER_ID AND "SOURCE_PLATFORM" = 'NETSUITE'
LEFT JOIN "VW_ACCOUNTING_PERIODS"         AS  ap 	ON opp.ACCOUNTING_PERIOD_ID        = ap.ACCOUNTING_PERIOD_ID          
;
